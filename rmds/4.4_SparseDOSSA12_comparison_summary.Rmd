---
title: "SparseDOSSA 2 is more similar to real dataset permutations"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(magrittr)
library(ggplot2)
```

# Real dataset permutaiton yields results between SparseDOSSA 1 and 2

* Pre-filtering included for testing
* SparseDOSSA 1 results (n=200) similar to MaAsLin2 evaluation
* Real data permutation generated by subsampling the original stool dataset to targeted sample size; real data
  spiking-in performed by multiplying counts of spiked-in species in cases with the same effect size (exp(2)).
* Real-data's FDR and power performance betwen SparseDOSSA 1 and 2, and seems to be more similar to SparseDOSSA 2.

## Null case (no associations in simulated data)
```{r SparseDOSSA 2 results, fig.width = 8, fig.height = 3}
# generate results
load("results/all_comparison/tb_job.RData")
batchtools::loadRegistry(file.dir = "r_batchtools_reg/all_comparison", 
                         writeable = FALSE)
tb_results <- tb_job %>% 
  tidyr::expand_grid(r = seq(1, 20)) %>% 
  dplyr::filter(i_job %in% batchtools::findDone()$job.id) %>% 
  dplyr::group_by(i_job, r) %>% 
  dplyr::mutate(fit = {
    load(paste0("results/all_comparison/fit_", i_job, "_", r, ".RData"))
    list(fit)
  }) %>% 
  dplyr::ungroup()

tb_summary_null <- tb_results %>% 
  dplyr::filter(effect == 0) %>% 
  dplyr::mutate(Method = factor(method, levels = c("DESeq2", "edgeR", "limmaVOOM", "ANCOM", "MaAsLin2"))) %>% 
  dplyr::group_by(i_job, r) %>% 
  dplyr::mutate(
    n_FP = 
      sum(fit[[1]]$qval < 0.05, na.rm = TRUE),
    n_P = 
      sum(fit[[1]]$qval < 0.05, na.rm = TRUE)
    ) %>% 
  dplyr::group_by(n, Method, sim_method) %>%
  dplyr::summarise(
    FDR = mean(n_FP / (n_P + 1e-10)),
    FDR_sd = sd(n_FP / (n_P + 1e-10)) / sqrt(20)
    # Sensitivity = mean(n_TP / length(features_toSpike))
    # Sensitivity_sd = sd(n_TP / length(features_toSpike)) / sqrt(10)
  ) %>%
  dplyr::ungroup()

p_FDR <- tb_summary_null %>% 
  ggplot(aes(x = factor(n),
             y = FDR,
             color = Method)) +
  geom_point(position = position_dodge(width = 0.25)) +
  geom_errorbar(aes(ymin = FDR - FDR_sd,
                    ymax = FDR + FDR_sd),
                width = 0.25,
                position = position_dodge(width = 0.25)) +
  facet_wrap(~sim_method) +
  theme_bw() +
  theme(legend.position = c(0.01, 0.99),
        legend.justification = c(0, 1),
        legend.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("Null case (no associations)")
print(p_FDR)
```

## Spiked case (5% features spiked in simulated data)
```{r true associations, fig.width = 8, fig.height = 6}
tb_summary_TP <- tb_results %>% 
  dplyr::filter(effect > 0) %>% 
  dplyr::mutate(Method = factor(method, levels = c("DESeq2", "edgeR", "limmaVOOM", "ANCOM", "MaAsLin2"))) %>% 
  dplyr::group_by(i_job, r) %>% 
  dplyr::mutate(
    # n_TP = 
    #   sum(fit[[1]]$qval < 0.05 & stringr::str_detect(fit[[1]]$feature, "TP"), na.rm = TRUE),
    # n_FP = 
    #   sum(fit[[1]]$qval < 0.05 & !stringr::str_detect(fit[[1]]$feature, "TP"), na.rm = TRUE),
    # n_P = 
    #   sum(fit[[1]]$qval < 0.05, na.rm = TRUE),
    n_TP = 
      sum(fit[[1]]$pval < 0.05 & stringr::str_detect(fit[[1]]$feature, "TP"), na.rm = TRUE),
    n_FP = 
      sum(fit[[1]]$pval < 0.05 & !stringr::str_detect(fit[[1]]$feature, "TP"), na.rm = TRUE),
    n_P = 
      sum(fit[[1]]$pval < 0.05, na.rm = TRUE)
  ) %>% 
  dplyr::group_by(n, Method, sim_method, effect) %>%
  dplyr::summarise(
    Power = mean(n_TP / 16),
    Power_sd = sd(n_TP / 16) / sqrt(20),
    FDR = mean(n_FP / (n_P + 1e-10)),
    FDR_sd = sd(n_FP / (n_P + 1e-10)) / sqrt(20),
    FPR = mean(n_FP / 315),
    FPR_sd = sd(n_FP / 315) / sqrt(10)
  ) %>%
  dplyr::ungroup()

p_power2 <- tb_summary_TP %>% 
  ggplot(aes(x = factor(n),
             y = Power,
             color = Method)) +
  geom_point(position = position_dodge(width = 0.25)) +
  geom_errorbar(aes(ymin = Power - Power_sd,
                    ymax = Power + Power_sd),
                width = 0.25,
                position = position_dodge(width = 0.25)) +
  facet_wrap(~sim_method + effect) +
  theme_bw() +
  theme(legend.position = c(0.01, 0.99),
        legend.justification = c(0, 1),
        legend.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("5% spiked")

p_FDR2 <- tb_summary_TP %>% 
  ggplot(aes(x = factor(n),
             y = FPR,
             color = Method)) +
  geom_point(position = position_dodge(width = 0.25)) +
  geom_errorbar(aes(ymin = FPR - FPR_sd,
                    ymax = FPR + FPR_sd),
                width = 0.25,
                position = position_dodge(width = 0.25)) +
  facet_wrap(~sim_method + effect) +
  theme_bw() +
  theme(legend.position = c(0.01, 0.99),
        legend.justification = c(0, 1),
        legend.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("")

print(cowplot::plot_grid(p_power2, p_FDR2, nrow = 2))
```

# Real data and SparseDOSSA 2 have more outliers than SparseDOSSA 1
* Notice many of the false positives from e.g. DESeq2 are from features that have high extreme values
* Plot the outlier pattern across features for each type of simulated data. That is, for each feature,
calculate maximum log(rel. abd.) - mean log(non-zero rel. abd.).
* Notice real data is distributed much more similarly to SparseDOSSA 2 than SparseDOSSA 1.
```{r examine per-feature distribution, fig.width = 6, fig.height = 3}
load("results/null_data/tb_sim.RData")
tb_range <- tb_sim %>% 
  dplyr::filter(spike == FALSE, n == 200, R == 1) %>% 
  dplyr::group_by(i_job_sim) %>% 
  dplyr::mutate(tb_range = {
    load(paste0("results/null_data/Simulation/", i_job_sim, 
                "_count.RData"))
    mat_norm <- apply(mat_count_simulated, 2, function(x) x / sum(x))
    tibble::tibble(
      method = sim_method,
      max_minus_mean = apply(mat_norm, 1, function(x) max(log(x[x > 0])) - mean(log(x[x > 0])))
    ) %>% list()
  }) %>% 
  extract2("tb_range") %>% 
  purrr::reduce(rbind)
p <- tb_range %>% 
  ggplot(aes(x = max_minus_mean)) +
  geom_histogram() +
  facet_wrap(.~method) +
  theme_bw()
print(p)
```
